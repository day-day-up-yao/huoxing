(window.webpackJsonp=window.webpackJsonp||[]).push([[79],{1511:function(e,t,a){"use strict";a.r(t);a(675);var r=a(676),n=a.n(r),i=(a(1376),a(1377)),o=a.n(i),l=(a(1396),a(1397)),s=a.n(l),c=(a(681),a(682)),p=a.n(c),u=(a(247),a(183)),d=a.n(u),f=(a(1388),a(1389)),m=a.n(f),h=(a(1387),a(50)),g=a.n(h),y=(a(361),a(20)),v=a.n(y),b=(a(678),a(363)),I=a.n(b),C=(a(184),a(1378)),w=a.n(C),S=(a(1379),a(1380)),L=a.n(S),O=a(0),U=a.n(O),E=a(246),j=(a(1606),a(1617)),N=a(1713),k=a(48);a(1712);function P(e){return(P="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function V(){return(V=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e}).apply(this,arguments)}function T(e,t){for(var a=0;a<t.length;a++){var r=t[a];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function x(e){return(x=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function F(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function q(e,t){return(q=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function _(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}var D=L.a.Item,A=w.a.TextArea,M=I.a.Group,R="",W=1,z=!1,J=[{label:"音频",value:"1"},{label:"视频",value:"2"}],G=function(e){function t(e){var a,r,n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),r=this,n=x(t).call(this,e),a=!n||"object"!==P(n)&&"function"!=typeof n?F(r):n,_(F(a),"insertState",function(e){e.map(function(e){a.state[e+"fileList"]=[],a.state[e+"coverImgUrl"]=""})}),_(F(a),"fileList",function(e){return[{uid:0,name:"xxx.png",status:"done",url:e}]}),_(F(a),"renderData",function(e){var t=a.fileList(e.coverUrl);a.setState({updateOrNot:!0,fileList:t,chapterfileList:[{uid:"uid-00000",fileName:e.title,name:e.title,fileUrl:e.key}],coverImgUrl:e.coverUrl,chapterUrl:e.key,loading:!1})}),_(F(a),"channelIdChange",function(e){a.setState({channelId:e.target.value})}),_(F(a),"cateIdChange",function(e){a.setState({cateId:e.target.value})}),_(F(a),"handleCancel",function(){return a.setState({previewVisible:!1})}),_(F(a),"handlePreview",function(e){if(e.hasOwnProperty("target")){var t=e.target.getAttribute("data-type");""!==a.state[t]?a.setState({previewImage:a.state[t],previewVisible:!0}):v.a.info("请先上传图片")}else a.setState({previewImage:e.url||e.thumbUrl,previewVisible:!0})}),_(F(a),"handleChange",function(e){var t=e.file,r=e.fileList;a.setState({fileList:r}),"removed"===t.status&&a.setState({coverImgUrl:""}),t.response&&(1===t.response.code&&"done"===t.status&&a.setState({coverImgUrl:t.response.obj}),"error"===t.status&&(v.a.error("网络错误，上传失败！"),a.setState({coverImgUrl:"",fileList:[]})))}),_(F(a),"handleUpload",function(){var e=a.state.chapterList[0],t=e.size,r=Math.ceil(t/2097152),n=new FormData;n.append("fileName",e.name),n.append("blockCount",r),n.append("currIndex",W),n.append("uploadId",R),n.append("uploadFile",null),n.append("type",1===parseInt(a.state.resType)?"college_audio":"college_video"),a.setState({uploading:!0}),a.UploadChapter(e,n,t,r,2097152)}),_(F(a),"UploadChapter",function(e,t,r,n,i){if(!z)try{var o=(W-1)*i,l=Math.min(r,o+i),s=e.slice(o,l);t.set("uploadFile",s),t.set("currIndex",W),t.set("uploadId",R),Object(k.l)("post","/file/upload",t,function(o,l){if(o.request)return clearInterval(a.timeOut),a.timeOut=setTimeout(function(){a.UploadChapter(e,t,r,n,i)},1e4),!1;if(o.response)return/^(5|4)\d{2}/.test(o.response.status)&&(clearInterval(a.timeOut),a.timeOut=setTimeout(function(){a.UploadChapter(e,t,r,n,i)},1e4)),!1;if(1===o.code){clearInterval(a.timeOut),1===W&&(R=o.obj);var s=W/n*100;W+1===n&&(s=99),a.setState({progressNum:parseFloat(s.toFixed(2))}),W<n&&(W+=1,a.UploadChapter(e,t,r,n,i))}else if(o.code<0)R="",W=1,v.a.error(o.msg);else if(2===o.code){clearInterval(a.timeOut),R="",W=1;var c=a.state.chapterfileList,p=[];c.map(function(e,t){p.push({uid:e.uid,fileName:e.name,name:e.name,fileUrl:o.obj})}),a.setState({chapterUrl:o.obj,chapterList:[],chapterfileList:p,uploading:!1,progressNum:0}),2===parseInt(a.state.resType)&&a.getCoverPic(o.obj),a.getDuration(o.obj),v.a.success("文件上传成功!")}else a.setState({uploading:!1,progressNum:0}),R="",W=1,v.a.error(o.msg)},a.state.cancel)}catch(e){console.log(e)}}),_(F(a),"chapterVisibleHide",function(){a.setState({chapterVisible:!1})}),_(F(a),"chapterVisibleShow",function(){a.setState({chapterVisible:!0})}),_(F(a),"delChapter",function(){a.setState({chapterfileList:[],chapterList:[],fileList:[],coverImgUrl:""})}),_(F(a),"handleSubmit",function(e){e.preventDefault();var t=F(a);if(a.state.uploading)return v.a.warning("章节正在上传, 请稍候提交!"),!1;a.props.form.setFieldsValue({coverUrl:a.state.coverImgUrl,isPay:1===a.state.isPay,resourceUrl:a.state.chapterUrl}),a.props.form.validateFieldsAndScroll(function(e,r){e||(a.setState({loading:!0}),r.id=a.props.location.query.id||"",r.resourceId=a.props.location.query.resourceId||a.props.chapterInfo.resourceId||"",r.duration=a.state.duration||0,r.isPay=r.isPay?1:0,a.state.updateOrNot&&!a.state.hasChanged&&delete r.resourceUrl,(!a.state.updateOrNot||!a.props.location.query.id)&&delete r.id,Object(k.i)("post","".concat(a.state.updateOrNot&&a.props.location.query.id?"/college/lesson/updateChapter":"/college/lesson/chapterAdd"),r,function(e){a.setState({loading:!1}),1===e.code?(v.a.success(a.state.updateOrNot?"修改成功！":"添加成功！"),t.closeWindow()):v.a.error(e.msg)}))})}),_(F(a),"createMarkup",function(e){return{__html:e}}),_(F(a),"closeWindow",function(){a.setState({closeLoading:!0})}),_(F(a),"resTypeChange",function(e){var t=a.props.form;"1"===e.target.value?t.setFieldsValue({resType:"1"}):t.setFieldsValue({resType:"2"}),a.setState({resType:e.target.value})}),_(F(a),"FormItem",function(e,t,r,n,i,o,l,s,c){var p=a.state.updateOrNot,u=a.props.form.getFieldDecorator,f=U.a.createElement("div",null,U.a.createElement(g.a,{type:"plus"}),U.a.createElement("div",{className:"ant-upload-text"},"上传图片"));return U.a.createElement(D,V({},{labelCol:{span:1},wrapperCol:{span:15,offset:1}},{label:r}),U.a.createElement("div",{className:"dropbox"},u(t,{initialValue:p&&i?o:"",rules:[{required:e,message:"请上传".concat(r,"封面！")}]})(U.a.createElement(m.a,{headers:{"Sign-Param":Object(k.A)()},action:"".concat(k.a,"/pic/upload"),name:"uploadFile",listType:"picture-card",fileList:o,onPreview:a.handlePreview,onChange:l},o.length>=1?null:f)),c?"":U.a.createElement(d.a,{"data-type":n,onClick:function(){a.getCoverPic(a.state.chapterUrl),a.getDuration(a.state.chapterUrl)},className:"img-preview",type:"primary"},"获取封面"),U.a.createElement("span",{className:"cover-img-tip"},"用于 ",r," 的封面展示")))}),a.state={cancel:!1,closeLoading:!1,updateOrNot:!1,topOrder:0,chapterfileList:[],chapterList:[],inputVisible:!1,inputValue:"",channelId:"1",chapterVisible:!1,cateId:"1",previewVisible:!1,previewImage:"",chapterUrl:"",uploading:!1,progressNum:0,loading:!0,isPay:!0,resType:"2",hasChanged:!1,confirmLoading:!1},a}var a,r,i;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&q(e,t)}(t,O["Component"]),a=t,(r=[{key:"componentWillMount",value:function(){this.insertState([""])}},{key:"componentDidMount",value:function(){var e=this,t=this.props,a=t.dispatch,r=t.location;r.query.id||r.query.url?a(Object(N.b)({id:r.query.id},function(t){e.renderData(t)})):(this.setState({loading:!1}),sessionStorage.setItem("hx_content",""))}},{key:"getCoverPic",value:function(e){var t=this;Object(k.i)("get","/college/media/snapshot",{url:e||this.state.chapterUrl,time:6},function(e){if(1!==e.code)return v.a.error(e.msg),!1;t.setState({fileList:t.fileList(e.obj),coverImgUrl:e.obj})})}},{key:"getDuration",value:function(e){var t=this;Object(k.i)("get","/college/media/duration",{url:e||this.state.chapterUrl},function(e){if(1!==e.code)return v.a.error(e.msg),!1;t.setState({duration:e.obj})})}},{key:"getResorceUrl",value:function(e){Object(k.i)("post","/college/lesson/chapterUrl",e,function(e){1===e.code?window.open(e.obj):v.a.error("获取课程链接错误, 请重试！")})}},{key:"render",value:function(){var e=this,t=this.props.form.getFieldDecorator,a=this.props,r=a.chapterInfo,i=a.location,l=this.state,c=l.hasChanged,u=l.progressNum,f=l.chapterfileList,h=l.uploading,y=l.previewVisible,v=l.previewImage,b=l.fileList,I=l.updateOrNot,C=l.resType,S={labelCol:{span:1},wrapperCol:{span:15,offset:1}};return U.a.createElement("div",{className:"chapter-send"},U.a.createElement(n.a,{spinning:this.state.loading,size:"large"},U.a.createElement(L.a,{onSubmit:this.handleSubmit},U.a.createElement(D,V({},S,{label:"章节类型: "}),t("resType",{initialValue:I&&r?"".concat(r.resType||"2"):"2"})(U.a.createElement(M,{options:J,onChange:this.resTypeChange,setFieldsValue:this.state.resType}))),U.a.createElement(D,V({},S,{label:"章节标题: "}),t("title",{initialValue:I&&r?"".concat(r.title):"",rules:[{required:!0,message:"请输入章节标题！"}]})(U.a.createElement(w.a,{placeholder:"请输入章节标题"}))),U.a.createElement(D,V({},S,{label:"章节简介: "}),t("text",{initialValue:I&&r?"".concat(r.text):"",rules:[{required:!0,message:"请输入章节简介"}]})(U.a.createElement(A,{className:"chapter-summary",placeholder:"请输入章节简介",rows:4}))),U.a.createElement(D,V({},S,{label:"章节上传"}),t("resourceUrl",{rules:[{required:!0,message:"请上传章节！"}]})(U.a.createElement(m.a,{name:"uploadFile",action:"/file/upload",accept:1===parseInt(C)?"audio/*":"video/*",onRemove:function(t){e.setState(function(e){var a=e.fileList,r=a.indexOf(t),n=a.slice();return n.splice(r,1),{chapterList:n,chapterfileList:n,fileList:[]}}),R="",W=1},beforeUpload:function(t){return e.setState({chapterList:[t],chapterfileList:[t],hasChanged:!0}),!1},fileList:this.state.chapterList},U.a.createElement(d.a,null,U.a.createElement(g.a,{type:"upload"})," 选择章节"))),0===f.length?"":f[0].fileName?U.a.createElement("div",{style:{margin:"10px 0 0"}},U.a.createElement("a",{target:"_blank",onClick:function(){var t=!c&&i.query.id?{id:i.query.id}:{url:e.state.chapterUrl};e.getResorceUrl(t)}},f[0].fileName),!h&&!i.query.id&&U.a.createElement("span",null," (解码需要1-2分钟, 请稍后点击查看)"),U.a.createElement(d.a,{size:"small",onClick:e.delChapter,style:{marginLeft:15,color:"#52b8fc",cursor:"pointer"}},"删除")):void 0,U.a.createElement(d.a,{style:{marginTop:16},className:"upload-demo-start",type:"primary",onClick:this.handleUpload,disabled:0===this.state.chapterList.length,loading:h},h?"上传中":"开始上传"),h&&U.a.createElement(p.a,{strokeWidth:5,style:{width:300,display:"block"},percent:u,status:"active"})),U.a.createElement(D,V({},S,{label:"是否付费: "}),t("isPay",{initialValue:!(!I||!r.isPay)&&1===parseInt(r.isPay),valuePropName:"checked"})(U.a.createElement(s.a,{onChange:function(t){e.setState({isPay:t?1:0})},checkedChildren:"是",unCheckedChildren:"否"}))),this.FormItem(!0,"coverUrl","播放器封面","coverImgUrl",r,b,this.handleChange,"285 * 160",!0),U.a.createElement(D,{wrapperCol:{span:12,offset:2}},U.a.createElement(d.a,{type:"primary","data-status":"1",onClick:this.handleSubmit,style:{marginRight:"10px"}},"添加"),U.a.createElement(d.a,{type:"primary",className:"cancel",onClick:this.closeWindow},"取消")),U.a.createElement(o.a,{visible:y,footer:null,onCancel:this.handleCancel},U.a.createElement("img",{alt:"example",style:{width:"100%"},src:v})))),this.state.closeLoading&&U.a.createElement(j.a,{handleCancel:function(t){clearInterval(t),e.setState({closeLoading:!1})},closeLoading:this.state.closeLoading}))}}])&&T(a.prototype,r),i&&T(a,i),t}();t.default=Object(E.connect)(function(e){return{userInfo:e.chapterInfo.userInfo,chapterInfo:e.chapterInfo.info}})(L.a.create()(G))}}]);